---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

##Install scfindME from source
```{r}
devtools::load_all("~/scfindME")
```

## Use pseudobulk Whippet quant output to build an original node-to-cell Psi matrix
```{r}
mo <- buildMatrix.original("/lustre/scratch117/cellgen/team218/gp7/Micro-exons/Runs/Paper/single_cell/MicroExonator/Whippet/Quant/Single_Cell/Pseudo_bulks/pseudo_bulks.psi.tsv")
```

## Scale the original matrix by Z-score or diff from mean
```{r}
mo.z <- scaleMatrix.z(mo)
mo.diff <- scaleMatrix.diff(mo)
```

## Build above and below index objects for both scailings
```{r}
m.above.z <- buildMatrix.above(mo.z)
m.above.diff <- buildMatrix.above(mo.diff)
m.below.z <- buildMatrix.below(mo.z)
m.below.diff <- buildMatrix.below(mo.diff)
```

```{r}
meta <- readr::read_tsv("/lustre/scratch117/cellgen/team218/gp7/Micro-exons/Runs/Paper/single_cell/MicroExonator/Whippet/Quant/Single_Cell/Pseudo_bulks/pseudo_bulk_membership.tsv")
meta <- data.frame(meta)
meta$primary_type <- gsub("_\\d*$", "", meta$pseudo_bulk_ID)
meta.new <- meta[-(340:345), ]
```

```{r}
metadata <- readRDS("~/scfindME_data/Tasic2016/pseudobulk_meta.rds")
```


```{r}
index.above.z <- buildAltSpliceIndex(m.above.z, metadata = metadata, dataset.name = "Tasic_2016", column.label = "primary_type")
index.above.diff <- buildAltSpliceIndex(m.above.diff, metadata = metadata, dataset.name = "Tasic_2016", column.label = "primary_type")
```

```{r}
index.below.z <- buildAltSpliceIndex(m.below.z, metadata = metadata, dataset.name = "Tasic_2016", column.label = "primary_type")
index.below.diff <- buildAltSpliceIndex(m.below.diff, metadata = metadata, dataset.name = "Tasic_2016", column.label = "primary_type")
```

#TODO add metadata to index

```{r}
index.above.z@metadata$node_list <- gene.node
index.below.z@metadata$node_list <- gene.node
```
##node_list
##stats

#store some useful variables
```{r}
node_list <- scfindGenes(index.above.z)
cell_types <- cellTypeNames(index.above.z)
```

#cellTypeMarkers

##TODO select those diff > 0.1
```{r}
markers_Chrna6 <- cellTypeMarkers(index.above.z, "Tasic_2016.L5_Chrna6")
markers_Chrna6
```

e.g. Snap25
ENSMUSG00000027273.13_9
ENSMUSG00000027273.13_10

```{r}
findCellTypes(index.above.z, "ENSMUSG00000027273.13_9")
```

```{r}
findCellTypes(index.below.z, "ENSMUSG00000027273.13_9")
```

## How do I store an internal dataset for node info since they don't change?

#hyperQueryCellTypes
```{r}
hyperQueryCellTypesAS(index.above.z, c("-ENSMUSG00000027273.13_9","ENSMUSG00000027273.13_10"))
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
